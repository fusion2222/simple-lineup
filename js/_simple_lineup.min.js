// This is very bad hack for checkboxes... but using WordPress requires the most harshest methods available.
var JsonizedCheckboxes = {
	
	WRAPPER_CLASS: 'js-frontend-jsonizer',
	OPTION_FIELD_CLASS: 'js-frontend-jsonizer--option',
	JSON_FIELD_CLASS: 'js-frontend-jsonizer--json-field',

	serializeOptions: function(wrapper){
		var options = wrapper.getElementsByClassName(this.OPTION_FIELD_CLASS);
		var output = [];
		for(var i = options.length - 1; i >= 0; i--){
			if(options[i].checked){
				output.push(options[i].value);
			}
		}
		wrapper.getElementsByClassName(this.JSON_FIELD_CLASS)[0].value = JSON.stringify(output);
	},
	registeEvents: function(){
		var doc = document;
		var options = doc.getElementsByClassName(this.OPTION_FIELD_CLASS);
		for(var i = options.length - 1; i >= 0; i--){
			options[i].addEventListener('change', function($event){
				JsonizedCheckboxes.serializeOptions(this.closest('.' + JsonizedCheckboxes.WRAPPER_CLASS));
			});
		}
	},
	init: function(){
		window.addEventListener('load', function(event) {
			JsonizedCheckboxes.registeEvents()
		});
	}
};

JsonizedCheckboxes.init();

var CountryfestShedulingWidget = {
	WIDGET_CLASS: 'js-sheduling-widget',

	SHOWBOX_FORM_CLASS: 'js-sheduling-widget--new-item',
	SHOWBOX_NEW_CLASS: 'new',
	SHOWBOX_FORM_FIELD_CLASS: 'js-sheduling-widget--new-item--field',
	SHOWBOX_FORM_ADD_BUTTON_CLASS: 'js-sheduling-widget--add-button',

	SHOWBOX_LIST_CLASS: 'js-sheduling-widget--item-wrapper',
	SHOWBOX_CLASS: 'js-sheduling-widget--item',
	SHOWBOX_DELETE_BUTTON_CLASS: 'js-sheduling-widget--item--delete-button',
	SHOWBOX_HIDDEN_CONTAINER: 'js-sheduling-widget--hidden-container',
	SHOWBOX_SHOW_ON_PROGRAM_ICON: 'js-sheduling-widget--item--yesno',

	YES_CLASS: 'dashicons-yes',
	NO_CLASS: 'dashicons-no',

	EVENT_HANDLER: {
		addNewShowbox: function(event){
			// find closest this.SHOWBOX and execute its create_new_showbox event.
			var fields = this.closest(
				'.' + CountryfestShedulingWidget.SHOWBOX_FORM_CLASS
			).getElementsByClassName(CountryfestShedulingWidget.SHOWBOX_FORM_FIELD_CLASS);

			var fieldValueMap = {};

			for(var i = fields.length - 1; i >= 0; i--){
				if(!fields[i].hasAttribute('data-name')){
					continue;
				}

				var fieldName = fields[i].getAttribute('data-name');

				if(fields[i].type === 'checkbox'){
					// show_on_program_page
					fieldValueMap[fieldName] = fields[i].checked;
					continue;
				}

				fieldValueMap[fieldName] = Number(fields[i].value);
			}

			var duration = {
				minutes: Number(fieldValueMap.duration__minutes),
				hours: Number(fieldValueMap.duration__hours),
				days: Number(fieldValueMap.duration__days)
			};

			duration.totalMinutes = duration.minutes + duration.hours * 60 + duration.days * 60 * 24;

			if(duration.minutes === 0 && duration.hours === 0 && duration.days === 0){
				alert('Duration cannot be zero');
				return;
			}

			var date = new Date();
			date.setUTCFullYear(fieldValueMap.start__year);
			date.setUTCMonth(fieldValueMap.start__month - 1);  // setUTCMonth expect month index to start from 0 instead 1!
			date.setUTCDate(fieldValueMap.start__day);  // setUTCDate - Date not Day!!!
			date.setUTCHours(fieldValueMap.start__hour);
			date.setUTCMinutes(fieldValueMap.start__minute)
			date.setUTCSeconds(0);
			date.setUTCMilliseconds(0);

			var event = new CustomEvent(
				'create_new_showbox', {'detail': {
						'startDate': date,
						'duration': duration,
						'showOnProgramPage': fieldValueMap.show_on_program_page
					}
				}
			);
			this.closest('.' + CountryfestShedulingWidget.WIDGET_CLASS).dispatchEvent(event);
		},
		deleteShowbox: function(event){
			// launches showbox delete
			var showbox = this.closest('.' + CountryfestShedulingWidget.SHOWBOX_CLASS);
			var showboxList = showbox.closest('.' + CountryfestShedulingWidget.SHOWBOX_LIST_CLASS);
			showbox.parentNode.removeChild(showbox);

			// Dispatch recalculate_field_indexes event.
			showboxList.dispatchEvent(new CustomEvent('recalculate_field_indexes'));
		},
		createNewShowbox: function(event){	
			// Lets assume we will always get correct args here
			// Lets create dummy copy of showbox, which will be later polluted by fields.
			var newShowBox = this.getElementsByClassName(
				CountryfestShedulingWidget.SHOWBOX_HIDDEN_CONTAINER
			)[0].getElementsByClassName(CountryfestShedulingWidget.SHOWBOX_CLASS)[0].cloneNode(true);

			newShowBox.className += ' ' + CountryfestShedulingWidget.SHOWBOX_NEW_CLASS;

			var hiddenFieldsMap = {
				simple_lineup__start: event.detail.startDate.toISOString(),  // Backend friendly standardized format.
				simple_lineup__duration: event.detail.duration.totalMinutes,
				simple_lineup__show_on_program_page: Number(event.detail.showOnProgramPage)
			};

			// Creates blank fake hidden field
			var blankHiddenField = document.createElement('input');
			blankHiddenField.type = 'hidden';

        	// Append all blank fields to newly created Showbox. So form will reflect added element.
        	for(var fieldName in hiddenFieldsMap){
        		var newHiddenField = blankHiddenField.cloneNode(true);
        		newHiddenField.name = fieldName;
        		newHiddenField.value = hiddenFieldsMap[fieldName];
				newShowBox.appendChild(newHiddenField);        		
        	}

        	CountryfestShedulingWidget.setUpShowbox(newShowBox, event.detail.startDate, event.detail.duration, event.detail.showOnProgramPage);

        	// Now append showbox to showbox wrapper.
        	var showBoxList = this.getElementsByClassName(CountryfestShedulingWidget.SHOWBOX_LIST_CLASS)[0];
			showBoxList.insertBefore(newShowBox, showBoxList.firstChild);
			showBoxList.dispatchEvent(new CustomEvent('recalculate_field_indexes'));
		},
		recalculateFieldIndexes: function(event){
			// This assigns indexes to all showboxes

			var showboxes = this.getElementsByClassName(CountryfestShedulingWidget.SHOWBOX_CLASS);

			var fieldRE = /^[\w_\d]+/;

			for (var i = showboxes.length - 1; i >= 0; i--) {
				var shoboxInputs = showboxes[i].getElementsByTagName('input');

				for (var x = shoboxInputs.length - 1; x >= 0; x--){
					// We have two possible formats here - `fieldname` and `fieldname[i]`.
					var fieldName = shoboxInputs[x].getAttribute('name').match(fieldRE);
					shoboxInputs[x].setAttribute('name', fieldName + '[' + i + ']');
				}

			}			
		}
	},
	formatShowBoxStartDate: function(date){
		return date;
	}, 
	numberWithPlaces: function(num, places){
		for(var output = String(num); output.length < places; output = '0' + output){};
		return output;
	},
	assignEventToAll: function(className, eventName, eventHandler){
		Array.from(document.getElementsByClassName(className)).forEach(function(item){
			item.addEventListener(eventName, eventHandler);
		});
	},
	setUpShowbox: function(showbox, startDate, duration, showOnProgramPage){
		showbox.getElementsByClassName(
			CountryfestShedulingWidget.SHOWBOX_DELETE_BUTTON_CLASS
		)[0].addEventListener('click', CountryfestShedulingWidget.EVENT_HANDLER.deleteShowbox);
		
		var formattedTime = String(startDate.getUTCHours()) + ':' + String(startDate.getUTCMinutes());
		var formattedDate = [startDate.getUTCDate(), startDate.getUTCMonth() + 1, startDate.getUTCFullYear()].join('.');
		var outputDuration = [];

		if(duration.days){
			outputDuration.push(String(duration.days) + 'd');
		}

		if(duration.hours){
			outputDuration.push(String(duration.hours) + 'h');
		}

		outputDuration.push(String(duration.minutes) + 'm');

		showbox.getElementsByClassName('js-sheduling-widget--item--duration')[0].innerHTML = outputDuration.join(' ');
		showbox.getElementsByClassName('js-sheduling-widget--item--start')[0].innerHTML = formattedTime + ' - ' + formattedDate;

		var showOnProgramPageIcon = showbox.getElementsByClassName(CountryfestShedulingWidget.SHOWBOX_SHOW_ON_PROGRAM_ICON)[0];
		var iconClasses = showOnProgramPageIcon.className.split(' ');
		var classesToRemove = [CountryfestShedulingWidget.YES_CLASS, CountryfestShedulingWidget.NO_CLASS];

		for(var i = classesToRemove.length - 1; i >= 0; i--){
			var classIndex = iconClasses.indexOf(classesToRemove[i]);
			
			if(classIndex === -1){
				continue;
			}

			iconClasses.splice(classIndex, 1);
		}

		iconClasses.push(showOnProgramPage ? CountryfestShedulingWidget.YES_CLASS : CountryfestShedulingWidget.NO_CLASS); 
		showOnProgramPageIcon.className = iconClasses.join(' ');

	},
	registerEvents: function(){
		this.assignEventToAll(this.SHOWBOX_FORM_ADD_BUTTON_CLASS, 'click', this.EVENT_HANDLER.addNewShowbox);
		this.assignEventToAll(this.SHOWBOX_DELETE_BUTTON_CLASS, 'click', this.EVENT_HANDLER.deleteShowbox);
		this.assignEventToAll(this.WIDGET_CLASS, 'create_new_showbox', this.EVENT_HANDLER.createNewShowbox);
		this.assignEventToAll(this.SHOWBOX_LIST_CLASS, 'recalculate_field_indexes', this.EVENT_HANDLER.recalculateFieldIndexes);
	},
	init: function(){
		this.registerEvents();
	}
};

window.addEventListener('DOMContentLoaded', function(event){
	CountryfestShedulingWidget.init();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzb25pemVkLWNoZWNrYm94ZXMuanMiLCJzaGVkdWxpbmctd2lkZ2V0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzaW1wbGVfbGluZXVwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgaXMgdmVyeSBiYWQgaGFjayBmb3IgY2hlY2tib3hlcy4uLiBidXQgdXNpbmcgV29yZFByZXNzIHJlcXVpcmVzIHRoZSBtb3N0IGhhcnNoZXN0IG1ldGhvZHMgYXZhaWxhYmxlLlxudmFyIEpzb25pemVkQ2hlY2tib3hlcyA9IHtcblx0XG5cdFdSQVBQRVJfQ0xBU1M6ICdqcy1mcm9udGVuZC1qc29uaXplcicsXG5cdE9QVElPTl9GSUVMRF9DTEFTUzogJ2pzLWZyb250ZW5kLWpzb25pemVyLS1vcHRpb24nLFxuXHRKU09OX0ZJRUxEX0NMQVNTOiAnanMtZnJvbnRlbmQtanNvbml6ZXItLWpzb24tZmllbGQnLFxuXG5cdHNlcmlhbGl6ZU9wdGlvbnM6IGZ1bmN0aW9uKHdyYXBwZXIpe1xuXHRcdHZhciBvcHRpb25zID0gd3JhcHBlci5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHRoaXMuT1BUSU9OX0ZJRUxEX0NMQVNTKTtcblx0XHR2YXIgb3V0cHV0ID0gW107XG5cdFx0Zm9yKHZhciBpID0gb3B0aW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSl7XG5cdFx0XHRpZihvcHRpb25zW2ldLmNoZWNrZWQpe1xuXHRcdFx0XHRvdXRwdXQucHVzaChvcHRpb25zW2ldLnZhbHVlKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0d3JhcHBlci5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHRoaXMuSlNPTl9GSUVMRF9DTEFTUylbMF0udmFsdWUgPSBKU09OLnN0cmluZ2lmeShvdXRwdXQpO1xuXHR9LFxuXHRyZWdpc3RlRXZlbnRzOiBmdW5jdGlvbigpe1xuXHRcdHZhciBkb2MgPSBkb2N1bWVudDtcblx0XHR2YXIgb3B0aW9ucyA9IGRvYy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHRoaXMuT1BUSU9OX0ZJRUxEX0NMQVNTKTtcblx0XHRmb3IodmFyIGkgPSBvcHRpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXtcblx0XHRcdG9wdGlvbnNbaV0uYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZnVuY3Rpb24oJGV2ZW50KXtcblx0XHRcdFx0SnNvbml6ZWRDaGVja2JveGVzLnNlcmlhbGl6ZU9wdGlvbnModGhpcy5jbG9zZXN0KCcuJyArIEpzb25pemVkQ2hlY2tib3hlcy5XUkFQUEVSX0NMQVNTKSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH0sXG5cdGluaXQ6IGZ1bmN0aW9uKCl7XG5cdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbihldmVudCkge1xuXHRcdFx0SnNvbml6ZWRDaGVja2JveGVzLnJlZ2lzdGVFdmVudHMoKVxuXHRcdH0pO1xuXHR9XG59O1xuXG5Kc29uaXplZENoZWNrYm94ZXMuaW5pdCgpO1xuIiwidmFyIENvdW50cnlmZXN0U2hlZHVsaW5nV2lkZ2V0ID0ge1xuXHRXSURHRVRfQ0xBU1M6ICdqcy1zaGVkdWxpbmctd2lkZ2V0JyxcblxuXHRTSE9XQk9YX0ZPUk1fQ0xBU1M6ICdqcy1zaGVkdWxpbmctd2lkZ2V0LS1uZXctaXRlbScsXG5cdFNIT1dCT1hfTkVXX0NMQVNTOiAnbmV3Jyxcblx0U0hPV0JPWF9GT1JNX0ZJRUxEX0NMQVNTOiAnanMtc2hlZHVsaW5nLXdpZGdldC0tbmV3LWl0ZW0tLWZpZWxkJyxcblx0U0hPV0JPWF9GT1JNX0FERF9CVVRUT05fQ0xBU1M6ICdqcy1zaGVkdWxpbmctd2lkZ2V0LS1hZGQtYnV0dG9uJyxcblxuXHRTSE9XQk9YX0xJU1RfQ0xBU1M6ICdqcy1zaGVkdWxpbmctd2lkZ2V0LS1pdGVtLXdyYXBwZXInLFxuXHRTSE9XQk9YX0NMQVNTOiAnanMtc2hlZHVsaW5nLXdpZGdldC0taXRlbScsXG5cdFNIT1dCT1hfREVMRVRFX0JVVFRPTl9DTEFTUzogJ2pzLXNoZWR1bGluZy13aWRnZXQtLWl0ZW0tLWRlbGV0ZS1idXR0b24nLFxuXHRTSE9XQk9YX0hJRERFTl9DT05UQUlORVI6ICdqcy1zaGVkdWxpbmctd2lkZ2V0LS1oaWRkZW4tY29udGFpbmVyJyxcblx0U0hPV0JPWF9TSE9XX09OX1BST0dSQU1fSUNPTjogJ2pzLXNoZWR1bGluZy13aWRnZXQtLWl0ZW0tLXllc25vJyxcblxuXHRZRVNfQ0xBU1M6ICdkYXNoaWNvbnMteWVzJyxcblx0Tk9fQ0xBU1M6ICdkYXNoaWNvbnMtbm8nLFxuXG5cdEVWRU5UX0hBTkRMRVI6IHtcblx0XHRhZGROZXdTaG93Ym94OiBmdW5jdGlvbihldmVudCl7XG5cdFx0XHQvLyBmaW5kIGNsb3Nlc3QgdGhpcy5TSE9XQk9YIGFuZCBleGVjdXRlIGl0cyBjcmVhdGVfbmV3X3Nob3dib3ggZXZlbnQuXG5cdFx0XHR2YXIgZmllbGRzID0gdGhpcy5jbG9zZXN0KFxuXHRcdFx0XHQnLicgKyBDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0ZPUk1fQ0xBU1Ncblx0XHRcdCkuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0ZPUk1fRklFTERfQ0xBU1MpO1xuXG5cdFx0XHR2YXIgZmllbGRWYWx1ZU1hcCA9IHt9O1xuXG5cdFx0XHRmb3IodmFyIGkgPSBmaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pe1xuXHRcdFx0XHRpZighZmllbGRzW2ldLmhhc0F0dHJpYnV0ZSgnZGF0YS1uYW1lJykpe1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0dmFyIGZpZWxkTmFtZSA9IGZpZWxkc1tpXS5nZXRBdHRyaWJ1dGUoJ2RhdGEtbmFtZScpO1xuXG5cdFx0XHRcdGlmKGZpZWxkc1tpXS50eXBlID09PSAnY2hlY2tib3gnKXtcblx0XHRcdFx0XHQvLyBzaG93X29uX3Byb2dyYW1fcGFnZVxuXHRcdFx0XHRcdGZpZWxkVmFsdWVNYXBbZmllbGROYW1lXSA9IGZpZWxkc1tpXS5jaGVja2VkO1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZmllbGRWYWx1ZU1hcFtmaWVsZE5hbWVdID0gTnVtYmVyKGZpZWxkc1tpXS52YWx1ZSk7XG5cdFx0XHR9XG5cblx0XHRcdHZhciBkdXJhdGlvbiA9IHtcblx0XHRcdFx0bWludXRlczogTnVtYmVyKGZpZWxkVmFsdWVNYXAuZHVyYXRpb25fX21pbnV0ZXMpLFxuXHRcdFx0XHRob3VyczogTnVtYmVyKGZpZWxkVmFsdWVNYXAuZHVyYXRpb25fX2hvdXJzKSxcblx0XHRcdFx0ZGF5czogTnVtYmVyKGZpZWxkVmFsdWVNYXAuZHVyYXRpb25fX2RheXMpXG5cdFx0XHR9O1xuXG5cdFx0XHRkdXJhdGlvbi50b3RhbE1pbnV0ZXMgPSBkdXJhdGlvbi5taW51dGVzICsgZHVyYXRpb24uaG91cnMgKiA2MCArIGR1cmF0aW9uLmRheXMgKiA2MCAqIDI0O1xuXG5cdFx0XHRpZihkdXJhdGlvbi5taW51dGVzID09PSAwICYmIGR1cmF0aW9uLmhvdXJzID09PSAwICYmIGR1cmF0aW9uLmRheXMgPT09IDApe1xuXHRcdFx0XHRhbGVydCgnRHVyYXRpb24gY2Fubm90IGJlIHplcm8nKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHR2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7XG5cdFx0XHRkYXRlLnNldFVUQ0Z1bGxZZWFyKGZpZWxkVmFsdWVNYXAuc3RhcnRfX3llYXIpO1xuXHRcdFx0ZGF0ZS5zZXRVVENNb250aChmaWVsZFZhbHVlTWFwLnN0YXJ0X19tb250aCAtIDEpOyAgLy8gc2V0VVRDTW9udGggZXhwZWN0IG1vbnRoIGluZGV4IHRvIHN0YXJ0IGZyb20gMCBpbnN0ZWFkIDEhXG5cdFx0XHRkYXRlLnNldFVUQ0RhdGUoZmllbGRWYWx1ZU1hcC5zdGFydF9fZGF5KTsgIC8vIHNldFVUQ0RhdGUgLSBEYXRlIG5vdCBEYXkhISFcblx0XHRcdGRhdGUuc2V0VVRDSG91cnMoZmllbGRWYWx1ZU1hcC5zdGFydF9faG91cik7XG5cdFx0XHRkYXRlLnNldFVUQ01pbnV0ZXMoZmllbGRWYWx1ZU1hcC5zdGFydF9fbWludXRlKVxuXHRcdFx0ZGF0ZS5zZXRVVENTZWNvbmRzKDApO1xuXHRcdFx0ZGF0ZS5zZXRVVENNaWxsaXNlY29uZHMoMCk7XG5cblx0XHRcdHZhciBldmVudCA9IG5ldyBDdXN0b21FdmVudChcblx0XHRcdFx0J2NyZWF0ZV9uZXdfc2hvd2JveCcsIHsnZGV0YWlsJzoge1xuXHRcdFx0XHRcdFx0J3N0YXJ0RGF0ZSc6IGRhdGUsXG5cdFx0XHRcdFx0XHQnZHVyYXRpb24nOiBkdXJhdGlvbixcblx0XHRcdFx0XHRcdCdzaG93T25Qcm9ncmFtUGFnZSc6IGZpZWxkVmFsdWVNYXAuc2hvd19vbl9wcm9ncmFtX3BhZ2Vcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdCk7XG5cdFx0XHR0aGlzLmNsb3Nlc3QoJy4nICsgQ291bnRyeWZlc3RTaGVkdWxpbmdXaWRnZXQuV0lER0VUX0NMQVNTKS5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcblx0XHR9LFxuXHRcdGRlbGV0ZVNob3dib3g6IGZ1bmN0aW9uKGV2ZW50KXtcblx0XHRcdC8vIGxhdW5jaGVzIHNob3dib3ggZGVsZXRlXG5cdFx0XHR2YXIgc2hvd2JveCA9IHRoaXMuY2xvc2VzdCgnLicgKyBDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0NMQVNTKTtcblx0XHRcdHZhciBzaG93Ym94TGlzdCA9IHNob3dib3guY2xvc2VzdCgnLicgKyBDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0xJU1RfQ0xBU1MpO1xuXHRcdFx0c2hvd2JveC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNob3dib3gpO1xuXG5cdFx0XHQvLyBEaXNwYXRjaCByZWNhbGN1bGF0ZV9maWVsZF9pbmRleGVzIGV2ZW50LlxuXHRcdFx0c2hvd2JveExpc3QuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3JlY2FsY3VsYXRlX2ZpZWxkX2luZGV4ZXMnKSk7XG5cdFx0fSxcblx0XHRjcmVhdGVOZXdTaG93Ym94OiBmdW5jdGlvbihldmVudCl7XHRcblx0XHRcdC8vIExldHMgYXNzdW1lIHdlIHdpbGwgYWx3YXlzIGdldCBjb3JyZWN0IGFyZ3MgaGVyZVxuXHRcdFx0Ly8gTGV0cyBjcmVhdGUgZHVtbXkgY29weSBvZiBzaG93Ym94LCB3aGljaCB3aWxsIGJlIGxhdGVyIHBvbGx1dGVkIGJ5IGZpZWxkcy5cblx0XHRcdHZhciBuZXdTaG93Qm94ID0gdGhpcy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFxuXHRcdFx0XHRDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0hJRERFTl9DT05UQUlORVJcblx0XHRcdClbMF0uZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0NMQVNTKVswXS5jbG9uZU5vZGUodHJ1ZSk7XG5cblx0XHRcdG5ld1Nob3dCb3guY2xhc3NOYW1lICs9ICcgJyArIENvdW50cnlmZXN0U2hlZHVsaW5nV2lkZ2V0LlNIT1dCT1hfTkVXX0NMQVNTO1xuXG5cdFx0XHR2YXIgaGlkZGVuRmllbGRzTWFwID0ge1xuXHRcdFx0XHRzaW1wbGVfbGluZXVwX19zdGFydDogZXZlbnQuZGV0YWlsLnN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLCAgLy8gQmFja2VuZCBmcmllbmRseSBzdGFuZGFyZGl6ZWQgZm9ybWF0LlxuXHRcdFx0XHRzaW1wbGVfbGluZXVwX19kdXJhdGlvbjogZXZlbnQuZGV0YWlsLmR1cmF0aW9uLnRvdGFsTWludXRlcyxcblx0XHRcdFx0c2ltcGxlX2xpbmV1cF9fc2hvd19vbl9wcm9ncmFtX3BhZ2U6IE51bWJlcihldmVudC5kZXRhaWwuc2hvd09uUHJvZ3JhbVBhZ2UpXG5cdFx0XHR9O1xuXG5cdFx0XHQvLyBDcmVhdGVzIGJsYW5rIGZha2UgaGlkZGVuIGZpZWxkXG5cdFx0XHR2YXIgYmxhbmtIaWRkZW5GaWVsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG5cdFx0XHRibGFua0hpZGRlbkZpZWxkLnR5cGUgPSAnaGlkZGVuJztcblxuICAgICAgICBcdC8vIEFwcGVuZCBhbGwgYmxhbmsgZmllbGRzIHRvIG5ld2x5IGNyZWF0ZWQgU2hvd2JveC4gU28gZm9ybSB3aWxsIHJlZmxlY3QgYWRkZWQgZWxlbWVudC5cbiAgICAgICAgXHRmb3IodmFyIGZpZWxkTmFtZSBpbiBoaWRkZW5GaWVsZHNNYXApe1xuICAgICAgICBcdFx0dmFyIG5ld0hpZGRlbkZpZWxkID0gYmxhbmtIaWRkZW5GaWVsZC5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgIFx0XHRuZXdIaWRkZW5GaWVsZC5uYW1lID0gZmllbGROYW1lO1xuICAgICAgICBcdFx0bmV3SGlkZGVuRmllbGQudmFsdWUgPSBoaWRkZW5GaWVsZHNNYXBbZmllbGROYW1lXTtcblx0XHRcdFx0bmV3U2hvd0JveC5hcHBlbmRDaGlsZChuZXdIaWRkZW5GaWVsZCk7ICAgICAgICBcdFx0XG4gICAgICAgIFx0fVxuXG4gICAgICAgIFx0Q291bnRyeWZlc3RTaGVkdWxpbmdXaWRnZXQuc2V0VXBTaG93Ym94KG5ld1Nob3dCb3gsIGV2ZW50LmRldGFpbC5zdGFydERhdGUsIGV2ZW50LmRldGFpbC5kdXJhdGlvbiwgZXZlbnQuZGV0YWlsLnNob3dPblByb2dyYW1QYWdlKTtcblxuICAgICAgICBcdC8vIE5vdyBhcHBlbmQgc2hvd2JveCB0byBzaG93Ym94IHdyYXBwZXIuXG4gICAgICAgIFx0dmFyIHNob3dCb3hMaXN0ID0gdGhpcy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKENvdW50cnlmZXN0U2hlZHVsaW5nV2lkZ2V0LlNIT1dCT1hfTElTVF9DTEFTUylbMF07XG5cdFx0XHRzaG93Qm94TGlzdC5pbnNlcnRCZWZvcmUobmV3U2hvd0JveCwgc2hvd0JveExpc3QuZmlyc3RDaGlsZCk7XG5cdFx0XHRzaG93Qm94TGlzdC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgncmVjYWxjdWxhdGVfZmllbGRfaW5kZXhlcycpKTtcblx0XHR9LFxuXHRcdHJlY2FsY3VsYXRlRmllbGRJbmRleGVzOiBmdW5jdGlvbihldmVudCl7XG5cdFx0XHQvLyBUaGlzIGFzc2lnbnMgaW5kZXhlcyB0byBhbGwgc2hvd2JveGVzXG5cblx0XHRcdHZhciBzaG93Ym94ZXMgPSB0aGlzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoQ291bnRyeWZlc3RTaGVkdWxpbmdXaWRnZXQuU0hPV0JPWF9DTEFTUyk7XG5cblx0XHRcdHZhciBmaWVsZFJFID0gL15bXFx3X1xcZF0rLztcblxuXHRcdFx0Zm9yICh2YXIgaSA9IHNob3dib3hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuXHRcdFx0XHR2YXIgc2hvYm94SW5wdXRzID0gc2hvd2JveGVzW2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpO1xuXG5cdFx0XHRcdGZvciAodmFyIHggPSBzaG9ib3hJbnB1dHMubGVuZ3RoIC0gMTsgeCA+PSAwOyB4LS0pe1xuXHRcdFx0XHRcdC8vIFdlIGhhdmUgdHdvIHBvc3NpYmxlIGZvcm1hdHMgaGVyZSAtIGBmaWVsZG5hbWVgIGFuZCBgZmllbGRuYW1lW2ldYC5cblx0XHRcdFx0XHR2YXIgZmllbGROYW1lID0gc2hvYm94SW5wdXRzW3hdLmdldEF0dHJpYnV0ZSgnbmFtZScpLm1hdGNoKGZpZWxkUkUpO1xuXHRcdFx0XHRcdHNob2JveElucHV0c1t4XS5zZXRBdHRyaWJ1dGUoJ25hbWUnLCBmaWVsZE5hbWUgKyAnWycgKyBpICsgJ10nKTtcblx0XHRcdFx0fVxuXG5cdFx0XHR9XHRcdFx0XG5cdFx0fVxuXHR9LFxuXHRmb3JtYXRTaG93Qm94U3RhcnREYXRlOiBmdW5jdGlvbihkYXRlKXtcblx0XHRyZXR1cm4gZGF0ZTtcblx0fSwgXG5cdG51bWJlcldpdGhQbGFjZXM6IGZ1bmN0aW9uKG51bSwgcGxhY2VzKXtcblx0XHRmb3IodmFyIG91dHB1dCA9IFN0cmluZyhudW0pOyBvdXRwdXQubGVuZ3RoIDwgcGxhY2VzOyBvdXRwdXQgPSAnMCcgKyBvdXRwdXQpe307XG5cdFx0cmV0dXJuIG91dHB1dDtcblx0fSxcblx0YXNzaWduRXZlbnRUb0FsbDogZnVuY3Rpb24oY2xhc3NOYW1lLCBldmVudE5hbWUsIGV2ZW50SGFuZGxlcil7XG5cdFx0QXJyYXkuZnJvbShkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSkpLmZvckVhY2goZnVuY3Rpb24oaXRlbSl7XG5cdFx0XHRpdGVtLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBldmVudEhhbmRsZXIpO1xuXHRcdH0pO1xuXHR9LFxuXHRzZXRVcFNob3dib3g6IGZ1bmN0aW9uKHNob3dib3gsIHN0YXJ0RGF0ZSwgZHVyYXRpb24sIHNob3dPblByb2dyYW1QYWdlKXtcblx0XHRzaG93Ym94LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXG5cdFx0XHRDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX0RFTEVURV9CVVRUT05fQ0xBU1Ncblx0XHQpWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgQ291bnRyeWZlc3RTaGVkdWxpbmdXaWRnZXQuRVZFTlRfSEFORExFUi5kZWxldGVTaG93Ym94KTtcblx0XHRcblx0XHR2YXIgZm9ybWF0dGVkVGltZSA9IFN0cmluZyhzdGFydERhdGUuZ2V0VVRDSG91cnMoKSkgKyAnOicgKyBTdHJpbmcoc3RhcnREYXRlLmdldFVUQ01pbnV0ZXMoKSk7XG5cdFx0dmFyIGZvcm1hdHRlZERhdGUgPSBbc3RhcnREYXRlLmdldFVUQ0RhdGUoKSwgc3RhcnREYXRlLmdldFVUQ01vbnRoKCkgKyAxLCBzdGFydERhdGUuZ2V0VVRDRnVsbFllYXIoKV0uam9pbignLicpO1xuXHRcdHZhciBvdXRwdXREdXJhdGlvbiA9IFtdO1xuXG5cdFx0aWYoZHVyYXRpb24uZGF5cyl7XG5cdFx0XHRvdXRwdXREdXJhdGlvbi5wdXNoKFN0cmluZyhkdXJhdGlvbi5kYXlzKSArICdkJyk7XG5cdFx0fVxuXG5cdFx0aWYoZHVyYXRpb24uaG91cnMpe1xuXHRcdFx0b3V0cHV0RHVyYXRpb24ucHVzaChTdHJpbmcoZHVyYXRpb24uaG91cnMpICsgJ2gnKTtcblx0XHR9XG5cblx0XHRvdXRwdXREdXJhdGlvbi5wdXNoKFN0cmluZyhkdXJhdGlvbi5taW51dGVzKSArICdtJyk7XG5cblx0XHRzaG93Ym94LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2pzLXNoZWR1bGluZy13aWRnZXQtLWl0ZW0tLWR1cmF0aW9uJylbMF0uaW5uZXJIVE1MID0gb3V0cHV0RHVyYXRpb24uam9pbignICcpO1xuXHRcdHNob3dib3guZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnanMtc2hlZHVsaW5nLXdpZGdldC0taXRlbS0tc3RhcnQnKVswXS5pbm5lckhUTUwgPSBmb3JtYXR0ZWRUaW1lICsgJyAtICcgKyBmb3JtYXR0ZWREYXRlO1xuXG5cdFx0dmFyIHNob3dPblByb2dyYW1QYWdlSWNvbiA9IHNob3dib3guZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5TSE9XQk9YX1NIT1dfT05fUFJPR1JBTV9JQ09OKVswXTtcblx0XHR2YXIgaWNvbkNsYXNzZXMgPSBzaG93T25Qcm9ncmFtUGFnZUljb24uY2xhc3NOYW1lLnNwbGl0KCcgJyk7XG5cdFx0dmFyIGNsYXNzZXNUb1JlbW92ZSA9IFtDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5ZRVNfQ0xBU1MsIENvdW50cnlmZXN0U2hlZHVsaW5nV2lkZ2V0Lk5PX0NMQVNTXTtcblxuXHRcdGZvcih2YXIgaSA9IGNsYXNzZXNUb1JlbW92ZS5sZW5ndGggLSAxOyBpID49IDA7IGktLSl7XG5cdFx0XHR2YXIgY2xhc3NJbmRleCA9IGljb25DbGFzc2VzLmluZGV4T2YoY2xhc3Nlc1RvUmVtb3ZlW2ldKTtcblx0XHRcdFxuXHRcdFx0aWYoY2xhc3NJbmRleCA9PT0gLTEpe1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblxuXHRcdFx0aWNvbkNsYXNzZXMuc3BsaWNlKGNsYXNzSW5kZXgsIDEpO1xuXHRcdH1cblxuXHRcdGljb25DbGFzc2VzLnB1c2goc2hvd09uUHJvZ3JhbVBhZ2UgPyBDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5ZRVNfQ0xBU1MgOiBDb3VudHJ5ZmVzdFNoZWR1bGluZ1dpZGdldC5OT19DTEFTUyk7IFxuXHRcdHNob3dPblByb2dyYW1QYWdlSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3Nlcy5qb2luKCcgJyk7XG5cblx0fSxcblx0cmVnaXN0ZXJFdmVudHM6IGZ1bmN0aW9uKCl7XG5cdFx0dGhpcy5hc3NpZ25FdmVudFRvQWxsKHRoaXMuU0hPV0JPWF9GT1JNX0FERF9CVVRUT05fQ0xBU1MsICdjbGljaycsIHRoaXMuRVZFTlRfSEFORExFUi5hZGROZXdTaG93Ym94KTtcblx0XHR0aGlzLmFzc2lnbkV2ZW50VG9BbGwodGhpcy5TSE9XQk9YX0RFTEVURV9CVVRUT05fQ0xBU1MsICdjbGljaycsIHRoaXMuRVZFTlRfSEFORExFUi5kZWxldGVTaG93Ym94KTtcblx0XHR0aGlzLmFzc2lnbkV2ZW50VG9BbGwodGhpcy5XSURHRVRfQ0xBU1MsICdjcmVhdGVfbmV3X3Nob3dib3gnLCB0aGlzLkVWRU5UX0hBTkRMRVIuY3JlYXRlTmV3U2hvd2JveCk7XG5cdFx0dGhpcy5hc3NpZ25FdmVudFRvQWxsKHRoaXMuU0hPV0JPWF9MSVNUX0NMQVNTLCAncmVjYWxjdWxhdGVfZmllbGRfaW5kZXhlcycsIHRoaXMuRVZFTlRfSEFORExFUi5yZWNhbGN1bGF0ZUZpZWxkSW5kZXhlcyk7XG5cdH0sXG5cdGluaXQ6IGZ1bmN0aW9uKCl7XG5cdFx0dGhpcy5yZWdpc3RlckV2ZW50cygpO1xuXHR9XG59O1xuXG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGV2ZW50KXtcblx0Q291bnRyeWZlc3RTaGVkdWxpbmdXaWRnZXQuaW5pdCgpO1xufSk7XG4iXX0=
